name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.23'

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        env:
          CGO_ENABLED: 1
          GOARCH: arm64
        run: |
          VERSION=${{ github.ref_name }}
          go build -ldflags="-s -w -X main.Version=${VERSION}" \
            -o dist/yippity-clippity \
            ./cmd/yippity-clippity

      - name: Create App Bundle
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p dist/Yippity-Clippity.app/Contents/{MacOS,Resources}
          cp dist/yippity-clippity dist/Yippity-Clippity.app/Contents/MacOS/yippity-clippity
          cp assets/Info.plist dist/Yippity-Clippity.app/Contents/

          # Copy icon if exists
          if [ -f assets/icons/icon.icns ]; then
            cp assets/icons/icon.icns dist/Yippity-Clippity.app/Contents/Resources/
          fi

          # Update Info.plist with version
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${VERSION}" \
            dist/Yippity-Clippity.app/Contents/Info.plist || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${VERSION}" \
            dist/Yippity-Clippity.app/Contents/Info.plist || true

          # Create zip for release
          ditto -c -k --keepParent dist/Yippity-Clippity.app dist/Yippity-Clippity-${VERSION}.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Yippity-Clippity-${{ github.ref_name }}.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
